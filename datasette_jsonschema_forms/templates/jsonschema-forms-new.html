{% extends "base.html" %}

{% block extra_head %}
<style>
  .form-group {
    margin-bottom: 1rem;
  }
  .form-group label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: bold;
  }
  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
  }
  .form-group textarea {
    height: 200px;
    font-family: monospace;
  }
  .submit-btn {
    background-color: #007bff;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
  }
  .submit-btn:hover {
    background-color: #0056b3;
  }
  .error {
    color: red;
    margin-top: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
  <main>
    <a href="{{urls.path("/-/jsonschema-forms")}}"><button>Back to JSONSchema forms</button></a>

    <h1>Create a new JSONSchema form</h1>

    <form id="new-form">
      <div class="form-group">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
      </div>

      <div class="form-group">
        <label for="schema">Schema (JSON):</label>
        <textarea id="schema" name="schema" required placeholder='{"type": "object", "properties": {...}}'></textarea>
      </div>

      <div class="form-group">
        <label for="database_name">Database Name:</label>
        <input type="text" id="database_name" name="database_name" required>
      </div>

      <div class="form-group">
        <label for="table_name">Table Name:</label>
        <input type="text" id="table_name" name="table_name" required>
      </div>

      <button type="submit" class="submit-btn">Create Form</button>
      <div id="error-message" class="error" style="display: none;"></div>
    </form>
  </main>

  <script>
    document.getElementById('new-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = {
        name: formData.get('name'),
        schema: formData.get('schema'),
        database_name: formData.get('database_name'),
        table_name: formData.get('table_name')
      };
      console.log(data);

      // Validate JSON schema
      try {
        JSON.parse(data.schema);
      } catch (error) {
        document.getElementById('error-message').textContent = 'Invalid JSON schema: ' + error.message;
        document.getElementById('error-message').style.display = 'block';
        return;
      }

      try {
        const response = await fetch('{{urls.path("/-/jsonschema-forms/api/new")}}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          // Redirect back to forms list on success
          //window.location.href = '{{urls.path("/-/jsonschema-forms")}}';
          response.text().then(console.log);
        } else {
          const errorData = await response.json();
          document.getElementById('error-message').textContent = 'Error: ' + (errorData.error || 'Failed to create form');
          document.getElementById('error-message').style.display = 'block';
        }
      } catch (error) {
        document.getElementById('error-message').textContent = 'Network error: ' + error.message;
        document.getElementById('error-message').style.display = 'block';
      }
    });
  </script>
{% endblock %}